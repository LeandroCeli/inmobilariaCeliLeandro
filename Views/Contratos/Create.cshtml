@model inmobilariaCeli.Models.Contrato
@{
    ViewData["Title"] = "Nuevo contrato";
    var inquilinos = ViewBag.Inquilinos as List<inmobilariaCeli.Models.Inquilino>;
}

<h2>Nuevo Contrato</h2>

<form asp-action="Create" method="post" id="formContrato">
    <!-- 1️⃣ Tipo de inmueble -->
    <div class="form-group">
        <label for="tipoInmueble">Tipo de Inmueble</label>
        <select id="tipoInmueble" class="form-control">
            <option value="">-- Seleccione --</option>
            <option value="Casa">Casa</option>
            <option value="Departamento">Departamento</option>
            <option value="Local Comercial">Local Comercial</option>
            <option value="Oficina">Oficina</option>
            <option value="Galpón">Galpón</option>
            <option value="Terreno">Terreno</option>
            <option value="PH">PH</option>
            <option value="Cochera">Cochera</option>
            <option value="Quinta">Quinta</option>
        </select>
    </div>

    <!-- 2️⃣ Tipo de uso -->
    <div class="form-group mt-2">
        <label for="tipoUso">Tipo de Uso</label>
        <select id="tipoUso" class="form-control">
            <option value="">-- Seleccione --</option>
            <option value="Residencial">Residencial</option>
            <option value="Comercial">Comercial</option>
            <option value="Profesional">Profesional</option>
            <option value="Industrial">Industrial</option>
            <option value="Recreativo">Recreativo</option>
            <option value="Mixto">Mixto</option>
            <option value="Institucional">Institucional</option>
        </select>
    </div>

    <!-- 3️⃣ Botón para buscar inmuebles disponibles -->
    <div class="form-group mt-3">
        <button type="button" id="btnBuscar" class="btn btn-primary">Buscar inmuebles disponibles</button>
    </div>

    <!-- 4️⃣ Inmuebles filtrados -->
    <div class="form-group mt-3">
        <label asp-for="IdPropiedad">Propiedad disponible</label>
        <select asp-for="IdPropiedad" id="selectInmueble" class="form-control">
            <option value="">-- Seleccione --</option>
        </select>
        <span asp-validation-for="IdPropiedad" class="text-danger"></span>
    </div>

    <!-- 5️⃣ Inquilino -->
    <div class="form-group mt-3">
        <label asp-for="IdInquilino">Inquilino</label>
        <select asp-for="IdInquilino" class="form-control" asp-items="@(new SelectList(inquilinos, "Id", "NombreCompleto"))">
            <option value="">-- Seleccione --</option>
        </select>
        <span asp-validation-for="IdInquilino" class="text-danger"></span>
    </div>

    <!-- 6️⃣ Fechas -->
    <div class="form-group mt-3">
        <label asp-for="FechaInicio"></label>
        <input asp-for="FechaInicio" class="form-control" type="date" />
        <span asp-validation-for="FechaInicio" class="text-danger"></span>
    </div>

    <div class="form-group mt-3">
        <label asp-for="FechaFin"></label>
        <input asp-for="FechaFin" class="form-control" type="date" />
        <span asp-validation-for="FechaFin" class="text-danger"></span>
    </div>

    <!-- 7️⃣ Monto y depósito -->
    <div class="form-group mt-3">
        <label asp-for="MontoMensual"></label>
        <input asp-for="MontoMensual" class="form-control" type="number" step="0.01" />
        <span asp-validation-for="MontoMensual" class="text-danger"></span>
    </div>

    <div class="form-group mt-3">
        <label asp-for="Deposito"></label>
        <input asp-for="Deposito" class="form-control" type="number" step="0.01" />
        <span asp-validation-for="Deposito" class="text-danger"></span>
    </div>

    <button type="submit" class="btn btn-success mt-3">Guardar</button>
    <a asp-action="Index" class="btn btn-secondary mt-3">Cancelar</a>
</form>

@section Scripts {
    <partial name="_ValidationScriptsPartial" />

    <script>
        document.getElementById("btnBuscar").addEventListener("click", function () {
            const tipoInmueble = document.getElementById("tipoInmueble").value;
            const tipoUso = document.getElementById("tipoUso").value;

            if (!tipoInmueble || !tipoUso) {
                alert("Seleccione el tipo de inmueble y tipo de uso primero.");
                return;
            }

            fetch(`/Contratos/GetInmueblesDisponibles?tipoInmueble=${tipoInmueble}&tipoUso=${tipoUso}`)
                .then(response => response.json())
                .then(data => {
                    const select = document.getElementById("selectInmueble");
                    select.innerHTML = '<option value="">-- Seleccione --</option>';
                    if (data.length === 0) {
                        alert("No hay inmuebles disponibles con esos criterios.");
                        return;
                    }
                    data.forEach(inmueble => {
                        const option = document.createElement("option");
                        option.value = inmueble.id;
                        option.text = `${inmueble.direccion} (${inmueble.tipoInmueble})`;
                        select.appendChild(option);
                    });
                });
        });
    </script>
}
